<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinKit 財富工具箱</title>
    
    <!-- 1. 載入 Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 載入 Babel (讓瀏覽器看得懂 React 程式碼) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 設定一些自定義樣式 -->
    <style>
        /* 隱藏列印時的特定元素 */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
        }
        /* 讓捲軸漂亮一點 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <!-- 5. 這裡開始是我們主要的應用程式邏輯 -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICON 元件定義 (因為單檔模式無法 import，我們手動定義圖示) ---
        const IconBase = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );

        const Calculator = (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const PieChart = (props) => <IconBase {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Menu = (props) => <IconBase {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const Percent = (props) => <IconBase {...props}><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></IconBase>;
        const Globe = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const DollarSign = (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>;
        const BarChart3 = (props) => <IconBase {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>;
        const Coins = (props) => <IconBase {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></IconBase>;


        // ==========================================
        // 共用組件 (UI Components)
        // ==========================================

        const InputGroup = ({ label, value, onChange, prefix, suffix, type = "number", step = "1", placeholder }) => (
            <div className="mb-4 no-print">
                <label className="block text-sm font-medium text-slate-600 mb-1">{label}</label>
                <div className="relative rounded-md shadow-sm">
                    {prefix && (
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span className="text-slate-500 sm:text-sm">{prefix}</span>
                        </div>
                    )}
                    <input
                        type={type}
                        step={step}
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                        placeholder={placeholder}
                        className={`focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-slate-300 rounded-md p-3 bg-slate-50 border ${prefix ? 'pl-10' : ''} ${suffix ? 'pr-10' : ''}`}
                    />
                    {suffix && (
                        <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <span className="text-slate-500 sm:text-sm">{suffix}</span>
                        </div>
                    )}
                </div>
            </div>
        );

        const ResultCard = ({ title, value, subtext, highlight = false, colorClass = "text-blue-700" }) => (
            <div className={`p-4 rounded-xl border print:border-slate-800 ${highlight ? 'bg-blue-50 border-blue-200 print:bg-white' : 'bg-white border-slate-200'}`}>
                <p className="text-sm text-slate-500 font-medium print:text-slate-600">{title}</p>
                <p className={`text-2xl font-bold mt-1 print:text-3xl ${highlight ? colorClass : 'text-slate-800'}`}>
                    {value}
                </p>
                {subtext && <p className="text-xs text-slate-400 mt-1 print:text-slate-500">{subtext}</p>}
            </div>
        );

        const SectionHeader = ({ title, icon: Icon, description, onPrint }) => (
            <div className="mb-6 flex justify-between items-start">
                <div>
                    <div className="flex items-center gap-2 mb-2">
                        <div className="p-2 bg-blue-100 rounded-lg text-blue-600 no-print">
                            <Icon size={24} />
                        </div>
                        <h2 className="text-xl font-bold text-slate-800 print:text-2xl">{title}</h2>
                    </div>
                    <p className="text-slate-500 text-sm print:text-slate-600">{description}</p>
                </div>
                <button 
                    onClick={onPrint}
                    className="hidden md:flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition-colors no-print shadow-sm"
                >
                    <Printer size={16} />
                    <span>列印 / 存成 PDF</span>
                </button>
            </div>
        );

        const ContentBlock = ({ title, children }) => (
            <div className="mt-8 bg-slate-50 rounded-2xl p-6 border border-slate-200 no-print">
                <h3 className="flex items-center gap-2 font-bold text-slate-800 mb-4">
                    <BookOpen size={20} className="text-blue-600" />
                    {title}
                </h3>
                <div className="prose prose-sm prose-slate max-w-none text-slate-600 space-y-3">
                    {children}
                </div>
            </div>
        );

        // ==========================================
        // 1. 稅務計算機 (Tax Calculator)
        // ==========================================
        const TaxCalculator = () => {
            const [income, setIncome] = useState(1500000);
            const [amtExemption, setAmtExemption] = useState(7500000);
            const [result, setResult] = useState({});

            const taxBrackets = [
                { limit: 610000, rate: 0.05, progressiveCorrection: 0 },
                { limit: 1330000, rate: 0.12, progressiveCorrection: 42700 },
                { limit: 2660000, rate: 0.20, progressiveCorrection: 149100 },
                { limit: 4980000, rate: 0.30, progressiveCorrection: 415100 },
                { limit: Infinity, rate: 0.40, progressiveCorrection: 913100 },
            ];

            useEffect(() => {
                const regularTax = (() => {
                    let bracket = taxBrackets.find(b => income <= b.limit) || taxBrackets[taxBrackets.length - 1];
                    return Math.max(0, Math.floor(income * bracket.rate - bracket.progressiveCorrection));
                })();

                let quota = (regularTax / 0.2) + amtExemption - income;
                if (quota < 1000000) quota = 1000000;

                setResult({ regularTax, quota });
            }, [income, amtExemption]);

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="2025 海外所得額度試算" 
                        icon={Calculator}
                        description="計算在不增加最低稅負的前提下，最高可配置的海外投資額度。"
                        onPrint={() => window.print()}
                    />
                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <InputGroup label="國內綜合所得淨額" value={income} onChange={setIncome} prefix="$" />
                            <InputGroup label="基本稅額免稅額 (預設750萬)" value={amtExemption} onChange={setAmtExemption} prefix="$" />
                        </div>
                        <div className="space-y-4 print:mt-4">
                            <ResultCard 
                                title="目前應繳一般所得稅" 
                                value={`$${new Intl.NumberFormat().format(result.regularTax)}`} 
                            />
                            <ResultCard 
                                title="建議海外所得配置上限" 
                                value={`$${new Intl.NumberFormat().format(Math.floor(result.quota))}`} 
                                subtext="此金額內免補繳基本稅額 (AMT)"
                                highlight={true}
                            />
                        </div>
                    </div>

                    <ContentBlock title="2025 報稅知識補給站">
                        <p><strong>1. 什麼是基本稅額 (AMT)？</strong><br/>
                        為了避免高所得者利用過多免稅規定完全不用繳稅，政府設有「最低稅負制」。當您的「基本稅額」大於「一般所得稅額」時，就必須補繳差額。</p>
                        
                        <p><strong>2. 海外所得多少不用申報？</strong><br/>
                        同一申報戶的全年海外所得總和若未達 <strong>100 萬元</strong>，則無須計入基本所得額；超過 100 萬則需「全數」計入。</p>
                    </ContentBlock>
                </div>
            );
        };

        // ==========================================
        // 2. 複利/單利計算機
        // ==========================================
        const CompoundCalculator = () => {
            const [principal, setPrincipal] = useState(100000);
            const [rate, setRate] = useState(5);
            const [years, setYears] = useState(10);
            const [type, setType] = useState('compound');

            const calculate = () => {
                const P = Number(principal);
                const r = Number(rate) / 100;
                const t = Number(years);
                
                let amount = 0;
                if (type === 'simple') {
                    amount = P * (1 + r * t);
                } else {
                    amount = P * Math.pow((1 + r), t);
                }
                return {
                    total: Math.floor(amount),
                    interest: Math.floor(amount - P)
                };
            };

            const res = calculate();

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="單利 / 複利計算機" 
                        icon={TrendingUp}
                        description="比較單利與複利的效果，展示時間帶來的財富增長。"
                        onPrint={() => window.print()}
                    />
                    
                    <div className="flex bg-slate-100 p-1 rounded-lg mb-6 w-full max-w-sm mx-auto no-print">
                        <button 
                            onClick={() => setType('compound')}
                            className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${type === 'compound' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                        >
                            複利計算
                        </button>
                        <button 
                            onClick={() => setType('simple')}
                            className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${type === 'simple' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                        >
                            單利計算
                        </button>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <InputGroup label="本金投入" value={principal} onChange={setPrincipal} prefix="$" />
                            <InputGroup label="年化報酬率" value={rate} onChange={setRate} suffix="%" />
                            <InputGroup label="投資年限" value={years} onChange={setYears} suffix="年" />
                        </div>
                        <div className="space-y-4 print:mt-4">
                            <ResultCard 
                                title={`${years} 年後總資產 (${type === 'compound' ? '複利' : '單利'})`} 
                                value={`$${new Intl.NumberFormat().format(res.total)}`} 
                                highlight={true}
                            />
                            <div className="grid grid-cols-2 gap-4">
                                <ResultCard 
                                    title="原始本金" 
                                    value={`$${new Intl.NumberFormat().format(principal)}`} 
                                />
                                <ResultCard 
                                    title="累積利息/獲利" 
                                    value={`$${new Intl.NumberFormat().format(res.interest)}`} 
                                    subtext={`報酬率 ${(res.interest/principal*100).toFixed(1)}%`}
                                />
                            </div>
                        </div>
                    </div>
                    <ContentBlock title="愛因斯坦：複利是世界第八大奇蹟">
                        <p><strong>單利 vs 複利：</strong>單利只有本金生利息；複利是利滾利。隨著時間拉長，複利效應呈指數成長。</p>
                    </ContentBlock>
                </div>
            );
        };

        // ==========================================
        // 3. 定期定額計算機
        // ==========================================
        const DcaCalculator = () => {
            const [monthly, setMonthly] = useState(10000);
            const [rate, setRate] = useState(6);
            const [years, setYears] = useState(20);

            const calculate = () => {
                const pmt = Number(monthly);
                const r = Number(rate) / 100 / 12;
                const n = Number(years) * 12;
                
                const fv = pmt * (Math.pow(1 + r, n) - 1) / r;
                const totalInvested = pmt * n;
                
                return {
                    fv: Math.floor(fv),
                    totalInvested: totalInvested,
                    profit: Math.floor(fv - totalInvested)
                };
            };

            const res = calculate();

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="定期定額試算" 
                        icon={RefreshCw}
                        description="計算每月固定投入資金，在複利效應下的長期累積成果。"
                        onPrint={() => window.print()}
                    />
                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <InputGroup label="每月投入金額" value={monthly} onChange={setMonthly} prefix="$" />
                            <InputGroup label="預期年化報酬率" value={rate} onChange={setRate} suffix="%" />
                            <InputGroup label="投資期間" value={years} onChange={setYears} suffix="年" />
                        </div>
                        <div className="space-y-4 print:mt-4">
                            <ResultCard 
                                title="期末總資產預估" 
                                value={`$${new Intl.NumberFormat().format(res.fv)}`} 
                                highlight={true}
                            />
                            <ResultCard 
                                title="總投入成本" 
                                value={`$${new Intl.NumberFormat().format(res.totalInvested)}`} 
                            />
                            <ResultCard 
                                title="投資獲利" 
                                value={`$${new Intl.NumberFormat().format(res.profit)}`} 
                                subtext={`總報酬率 ${(res.profit/res.totalInvested*100).toFixed(1)}%`}
                            />
                        </div>
                    </div>
                    <ContentBlock title="DCA 投資策略">
                        <p><strong>微笑曲線：</strong>下跌時同樣金額買更多單位，回升後獲利更豐。</p>
                    </ContentBlock>
                </div>
            );
        };

        // ==========================================
        // 4. 台股獲利試算
        // ==========================================
        const StockCalculator = () => {
            const [buyPrice, setBuyPrice] = useState(100);
            const [sellPrice, setSellPrice] = useState(110);
            const [shares, setShares] = useState(1000);
            const [feeDiscount, setFeeDiscount] = useState(60); 
            const [isDayTrading, setIsDayTrading] = useState(false);

            const calculate = () => {
                const FEE_RATE = 0.001425;
                const TAX_RATE = isDayTrading ? 0.0015 : 0.003;
                const discount = feeDiscount / 100;
                
                const totalShares = Number(shares);
                const buyVal = Number(buyPrice) * totalShares;
                const sellVal = Number(sellPrice) * totalShares;
                
                const buyFee = Math.floor(buyVal * FEE_RATE * discount);
                const sellFee = Math.floor(sellVal * FEE_RATE * discount);
                const tax = Math.floor(sellVal * TAX_RATE);
                
                const totalCost = buyVal + buyFee;
                const netIncome = sellVal - sellFee - tax;
                const profit = netIncome - totalCost;
                const roi = totalCost > 0 ? (profit / totalCost) * 100 : 0;
                
                return { buyFee, sellFee, tax, profit, roi, totalCost, netIncome };
            };

            const res = calculate();

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="台股交易獲利試算" 
                        icon={BarChart3}
                        description="支援現股與當沖稅率，可自訂券商手續費折數。"
                        onPrint={() => window.print()}
                    />
                    
                    <div className="flex bg-slate-100 p-1 rounded-lg mb-6 w-full max-w-sm mx-auto no-print">
                        <button 
                            onClick={() => setIsDayTrading(false)}
                            className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${!isDayTrading ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                        >
                            一般交易 (現股)
                        </button>
                        <button 
                            onClick={() => setIsDayTrading(true)}
                            className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${isDayTrading ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}
                        >
                            當沖交易 (稅減半)
                        </button>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <InputGroup label="買入價格" value={buyPrice} onChange={setBuyPrice} prefix="$" />
                            <InputGroup label="賣出價格" value={sellPrice} onChange={setSellPrice} prefix="$" />
                            <InputGroup label="股數 (張數請x1000)" value={shares} onChange={setShares} suffix="股" />
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-600 mb-1">券商手續費折數 ({feeDiscount}折)</label>
                                <input 
                                    type="range" min="10" max="100" step="5" 
                                    value={feeDiscount} 
                                    onChange={(e)=>setFeeDiscount(Number(e.target.value))}
                                    className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                />
                                <div className="flex justify-between text-xs text-slate-400 mt-1">
                                    <span>1折</span><span>28折</span><span>5折</span><span>6折</span><span>原價</span>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4 print:mt-4">
                            <ResultCard 
                                title="預估淨損益" 
                                value={`$${new Intl.NumberFormat().format(res.profit)}`} 
                                subtext={`報酬率 ${res.roi.toFixed(2)}%`}
                                highlight={true}
                                colorClass={res.profit >= 0 ? "text-red-600" : "text-green-600"}
                            />
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                    <p className="text-xs text-slate-500">交易成本合計</p>
                                    <p className="text-lg font-bold text-slate-700">${new Intl.NumberFormat().format(res.buyFee + res.sellFee + res.tax)}</p>
                                </div>
                                <div className="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                    <p className="text-xs text-slate-500">證交稅 ({isDayTrading ? '0.15%' : '0.3%'})</p>
                                    <p className="text-lg font-bold text-slate-700">${new Intl.NumberFormat().format(res.tax)}</p>
                                </div>
                            </div>

                            <div className="text-xs text-slate-400 space-y-1 no-print">
                                <p>• 買入手續費: ${res.buyFee}</p>
                                <p>• 賣出手續費: ${res.sellFee}</p>
                                <p>• 總付出成本: ${new Intl.NumberFormat().format(res.totalCost)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 5. 配息預估表
        // ==========================================
        const DividendCalculator = () => {
            const [shares, setShares] = useState(10000);
            const [price, setPrice] = useState(25);
            const [dividend, setDividend] = useState(1.5);
            const [freq, setFreq] = useState(1);

            const totalInvestment = shares * price;
            const annualIncome = shares * dividend;
            const yieldRate = price > 0 ? (dividend / price) * 100 : 0;
            const perPeriodIncome = annualIncome / freq;

            const getFreqLabel = () => {
                if(freq===1) return '年';
                if(freq===2) return '半年';
                if(freq===4) return '季';
                if(freq===12) return '月';
                return '';
            }

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="存股配息預估表" 
                        icon={Coins}
                        description="輸入持有股數與配息金額，試算未來現金流與殖利率。"
                        onPrint={() => window.print()}
                    />

                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <InputGroup label="持有股數" value={shares} onChange={setShares} suffix="股" />
                            <InputGroup label="目前股價 (預估成本)" value={price} onChange={setPrice} prefix="$" />
                            <InputGroup label="預估每股配息 (全年度合計)" value={dividend} onChange={setDividend} prefix="$" />
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-600 mb-2">配息頻率</label>
                                <div className="flex gap-2">
                                    {[{val: 1, label: '年配息'}, {val: 2, label: '半年配'}, {val: 4, label: '季配息'}, {val: 12, label: '月配息'}].map(opt => (
                                        <button key={opt.val} onClick={() => setFreq(opt.val)} className={`flex-1 py-2 text-sm rounded-lg border transition-colors ${freq === opt.val ? 'bg-blue-50 border-blue-500 text-blue-700 font-bold' : 'border-slate-200 hover:bg-slate-50'}`}>{opt.label}</button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4 print:mt-4">
                            <ResultCard 
                                title="預估年化殖利率" 
                                value={`${yieldRate.toFixed(2)}%`} 
                                highlight={true}
                            />
                            <ResultCard 
                                title="全年預估總股息" 
                                value={`$${new Intl.NumberFormat().format(Math.floor(annualIncome))}`} 
                                subtext={`總投入成本約 $${new Intl.NumberFormat().format(totalInvestment)}`}
                            />
                            
                            <div className="bg-blue-600 text-white p-4 rounded-xl shadow-md">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-blue-200 text-sm">平均每{getFreqLabel()}領取</span>
                                    <Coins size={16} className="text-blue-200"/>
                                </div>
                                <p className="text-3xl font-bold">
                                    ${new Intl.NumberFormat().format(Math.floor(perPeriodIncome))}
                                </p>
                            </div>
                        </div>
                    </div>
                    <ContentBlock title="存股族必看：殖利率陷阱">
                        <p><strong>填息才是真賺：</strong>高殖利率不代表高獲利。配息後股價會扣除配息金額，必須等股價漲回配息前的價格（填息），這筆股利才算是真正放進口袋。</p>
                    </ContentBlock>
                </div>
            );
        };

        // ==========================================
        // 6. FCN 計算機
        // ==========================================
        const FcnCalculator = () => {
            const [strikePrice, setStrikePrice] = useState(100);
            const [couponRate, setCouponRate] = useState(8);
            const [kiBarrier, setKiBarrier] = useState(65);
            const [investment, setInvestment] = useState(100000);
            
            const kiPrice = strikePrice * (kiBarrier / 100);
            const breakEvenPrice = strikePrice * (1 - (couponRate / 100));
            
            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="FCN / ELN 結構型商品快篩" 
                        icon={PieChart}
                        description="快速計算固定配息商品(Fixed Coupon Note)的下方保護與損益平衡點。"
                        onPrint={() => window.print()}
                    />
                    
                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <InputGroup label="投資名目本金" value={investment} onChange={setInvestment} prefix="$" />
                            <InputGroup label="標的目前股價 / 履約價 (Strike)" value={strikePrice} onChange={setStrikePrice} prefix="$" />
                            <InputGroup label="年化配息率 (Coupon)" value={couponRate} onChange={setCouponRate} suffix="%" />
                            <InputGroup label="下檔保護 (KI Barrier)" value={kiBarrier} onChange={setKiBarrier} suffix="%" />
                        </div>

                        <div className="space-y-4 print:mt-4">
                            <div className="bg-slate-800 text-white p-6 rounded-xl print:bg-slate-100 print:text-black print:border print:border-slate-300">
                                <p className="text-slate-400 text-sm mb-1 print:text-slate-600">關鍵安全防線 (KI Price)</p>
                                <p className="text-3xl font-bold mb-4">${kiPrice.toFixed(2)}</p>
                                <div className="h-2 bg-slate-700 rounded-full overflow-hidden print:bg-slate-300">
                                    <div className="h-full bg-red-500" style={{ width: `${kiBarrier}%` }}></div>
                                </div>
                                <p className="text-xs text-slate-400 mt-2 print:text-slate-600">股價跌破此價位可能面臨本金虧損 (接股票)</p>
                            </div>

                            <ResultCard 
                                title="損益兩平股價 (Breakeven)" 
                                value={`$${breakEvenPrice.toFixed(2)}`} 
                                subtext={`相當於現價下跌 ${(100 - (breakEvenPrice/strikePrice)*100).toFixed(1)}% 仍不賠錢`}
                                highlight={true}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 7. 房貸試算
        // ==========================================
        const LoanCalculator = () => {
            const [loanAmount, setLoanAmount] = useState(10000000);
            const [rate, setRate] = useState(2.1);
            const [years, setYears] = useState(30);

            const calculate = () => {
                const P = Number(loanAmount);
                const r = Number(rate) / 100 / 12;
                const n = Number(years) * 12;
                
                if (r === 0) return { monthly: P / n, totalInterest: 0, totalPay: P };
                
                const monthlyPayment = P * r * Math.pow(1 + r, n) / (Math.pow(1 + r, n) - 1);
                const totalPay = monthlyPayment * n;
                
                return {
                    monthly: Math.round(monthlyPayment),
                    totalInterest: Math.round(totalPay - P),
                    totalPay: Math.round(totalPay)
                };
            };

            const res = calculate();

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="房貸 / 信貸月付金試算" 
                        icon={Home}
                        description="採用本息平均攤還法，快速計算每月應繳金額與總利息成本。"
                        onPrint={() => window.print()}
                    />
                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <InputGroup label="貸款總金額" value={loanAmount} onChange={setLoanAmount} prefix="$" />
                            <InputGroup label="年利率" value={rate} onChange={setRate} suffix="%" step="0.01" />
                            <InputGroup label="貸款期限" value={years} onChange={setYears} suffix="年" />
                        </div>
                        <div className="space-y-4 print:mt-4">
                            <ResultCard 
                                title="每月應繳本息 (PMT)" 
                                value={`$${new Intl.NumberFormat().format(res.monthly)}`} 
                                highlight={true}
                            />
                            <ResultCard 
                                title="總利息支出" 
                                value={`$${new Intl.NumberFormat().format(res.totalInterest)}`} 
                                subtext={`總還款金額 $${new Intl.NumberFormat().format(res.totalPay)}`}
                            />
                        </div>
                    </div>
                    <ContentBlock title="房貸還款觀念">
                        <p><strong>本息攤還：</strong>每個月繳的金額固定，利息隨本金減少而遞減。</p>
                    </ContentBlock>
                </div>
            );
        };

        // ==========================================
        // 8. IRR 計算機
        // ==========================================
        const IrrCalculator = () => {
            const [mode, setMode] = useState('single'); 
            const [sPrincipal, setSPrincipal] = useState(1000000);
            const [sFinal, setSFinal] = useState(1200000);
            const [sYears, setSYears] = useState(6);
            const [rAnnual, setRAnnual] = useState(100000); 
            const [rPayYears, setRPayYears] = useState(6);  
            const [rWaitYears, setRWaitYears] = useState(10); 
            const [rFinal, setRFinal] = useState(700000);   

            const calcSingleIRR = () => {
                if (sPrincipal <= 0 || sFinal <= 0 || sYears <= 0) return 0;
                const irr = Math.pow(sFinal / sPrincipal, 1 / sYears) - 1;
                return (irr * 100).toFixed(2);
            };

            const calcRegularIRR = () => {
                let low = -0.99;
                let high = 1.0;
                let guess = 0;
                for (let i = 0; i < 50; i++) {
                    guess = (low + high) / 2;
                    let npv = 0;
                    for (let t = 0; t < rPayYears; t++) npv -= rAnnual / Math.pow(1 + guess, t);
                    npv += rFinal / Math.pow(1 + guess, rWaitYears);
                    if (Math.abs(npv) < 1) break;
                    if (npv > 0) low = guess; else high = guess;
                }
                return (guess * 100).toFixed(2);
            };

            const singleIrr = calcSingleIRR();
            const regularIrr = calcRegularIRR();

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader 
                        title="IRR 真實年化報酬率試算" 
                        icon={Percent}
                        description="破解「總報酬率」迷思，計算儲蓄險或長期投資的真實複利回報。"
                        onPrint={() => window.print()}
                    />

                    <div className="flex bg-slate-100 p-1 rounded-lg mb-6 w-full max-w-sm mx-auto no-print">
                        <button onClick={() => setMode('single')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'single' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>躉繳 (單筆)</button>
                        <button onClick={() => setMode('regular')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'regular' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>期繳 (分期)</button>
                    </div>
                    
                    {mode === 'single' ? (
                        <div className="grid md:grid-cols-2 gap-6 print:block">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                                <InputGroup label="投入本金" value={sPrincipal} onChange={setSPrincipal} prefix="$" />
                                <InputGroup label="期末領回金額" value={sFinal} onChange={setSFinal} prefix="$" />
                                <InputGroup label="經過年數" value={sYears} onChange={setSYears} suffix="年" />
                            </div>
                            <div className="space-y-4 print:mt-4">
                                <ResultCard title="IRR 內部報酬率 (年化)" value={`${singleIrr}%`} highlight={true} colorClass={Number(singleIrr) > 0 ? "text-green-600" : "text-red-600"}/>
                                <ResultCard title="總投資損益" value={`$${new Intl.NumberFormat().format(Math.floor(sFinal - sPrincipal))}`} subtext={`總報酬率 ${((sFinal - sPrincipal)/sPrincipal*100).toFixed(2)}%`}/>
                            </div>
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-2 gap-6 print:block">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                                <InputGroup label="每年繳納金額" value={rAnnual} onChange={setRAnnual} prefix="$" />
                                <InputGroup label="共繳費幾年" value={rPayYears} onChange={setRPayYears} suffix="年" />
                                <InputGroup label="於第幾年領回/解約" value={rWaitYears} onChange={setRWaitYears} suffix="年" />
                                <InputGroup label="屆時領回總額(解約金)" value={rFinal} onChange={setRFinal} prefix="$" />
                            </div>
                            <div className="space-y-4 print:mt-4">
                                <ResultCard title="IRR 內部報酬率 (年化)" value={`${regularIrr}%`} highlight={true} colorClass={Number(regularIrr) > 0 ? "text-green-600" : "text-red-600"}/>
                                <ResultCard title="總投入成本" value={`$${new Intl.NumberFormat().format(rAnnual * rPayYears)}`} />
                                <ResultCard title="總投資損益" value={`$${new Intl.NumberFormat().format(Math.floor(rFinal - (rAnnual * rPayYears)))}`} />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // 9. 雙向匯率換算機
        // ==========================================
        const ForexCalculator = () => {
            const [amount, setAmount] = useState(1000);
            const [fromCurr, setFromCurr] = useState('USD');
            const [toCurr, setToCurr] = useState('TWD');
            const [customRate, setCustomRate] = useState(null);

            const baseRates = {
                'TWD': 1, 'USD': 32.5, 'JPY': 0.22, 'EUR': 35.2, 'CNY': 4.5, 'AUD': 21.5, 'KRW': 0.024
            };

            const calculatedRate = baseRates[fromCurr] / baseRates[toCurr];
            const currentRate = customRate !== null ? customRate : calculatedRate;

            useEffect(() => { setCustomRate(null); }, [fromCurr, toCurr]);

            const result = amount * currentRate;

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <SectionHeader title="雙向匯率換算" icon={Globe} description="支援多國貨幣交叉匯率換算，可自訂成交匯率。" onPrint={() => window.print()}/>
                    <div className="grid md:grid-cols-2 gap-6 print:block">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">持有貨幣 (From)</label>
                                    <select value={fromCurr} onChange={(e)=>setFromCurr(e.target.value)} className="w-full p-2 border border-slate-300 rounded-md bg-slate-50">
                                        {Object.keys(baseRates).map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">兌換目標 (To)</label>
                                    <select value={toCurr} onChange={(e)=>setToCurr(e.target.value)} className="w-full p-2 border border-slate-300 rounded-md bg-slate-50">
                                        {Object.keys(baseRates).map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                            </div>
                            <InputGroup label={`輸入 ${fromCurr} 金額`} value={amount} onChange={setAmount} prefix="$" />
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-600 mb-1">成交匯率 (1 {fromCurr} = ? {toCurr})</label>
                                <input type="number" step="0.0001" value={currentRate.toFixed(4)} onChange={(e) => setCustomRate(parseFloat(e.target.value))} className="focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-slate-300 rounded-md p-3 bg-white border"/>
                                <p className="text-xs text-slate-400 mt-1">預設為銀行中價參考值，您可手動修改為實際成交價。</p>
                            </div>
                        </div>
                        <div className="space-y-4 print:mt-4">
                            <ResultCard title={`約合 ${toCurr} 金額`} value={`${new Intl.NumberFormat().format(result.toFixed(2))}`} subtext={`Rate: 1 ${fromCurr} ≈ ${currentRate.toFixed(4)} ${toCurr}`} highlight={true}/>
                            <div className="flex items-center justify-center p-4 bg-slate-50 rounded-xl border border-slate-200 no-print">
                                <ArrowRight className="text-slate-400 mr-4" />
                                <div className="text-center">
                                    <p className="text-sm text-slate-500">反向換算</p>
                                    <p className="font-bold text-slate-700">{amount} {toCurr} ≈ {(amount / currentRate).toFixed(2)} {fromCurr}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 主程式 (Main App)
        // ==========================================
        const FinancialToolkit = () => {
            const [activeTab, setActiveTab] = useState('tax');
            const [isMenuOpen, setIsMenuOpen] = useState(false);

            const menuCategories = [
                { title: "稅務與貸款", items: [{ id: 'tax', name: '稅務試算', icon: Calculator }, { id: 'loan', name: '房貸/信貸', icon: Home }] },
                { title: "投資與交易", items: [{ id: 'stock', name: '台股交易', icon: BarChart3 }, { id: 'dividend', name: '配息預估', icon: Coins }, { id: 'compound', name: '單利/複利', icon: TrendingUp }, { id: 'dca', name: '定期定額', icon: RefreshCw }, { id: 'irr', name: 'IRR/保單', icon: Percent }] },
                { title: "其他工具", items: [{ id: 'forex', name: '雙向匯率', icon: Globe }, { id: 'fcn', name: 'FCN/ELN', icon: PieChart }] }
            ];

            const renderContent = () => {
                switch (activeTab) {
                    case 'tax': return <TaxCalculator />;
                    case 'compound': return <CompoundCalculator />;
                    case 'dca': return <DcaCalculator />;
                    case 'fcn': return <FcnCalculator />;
                    case 'loan': return <LoanCalculator />;
                    case 'irr': return <IrrCalculator />;
                    case 'forex': return <ForexCalculator />;
                    case 'stock': return <StockCalculator />;
                    case 'dividend': return <DividendCalculator />;
                    default: return <TaxCalculator />;
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col md:flex-row print:bg-white">
                    <div className="md:hidden bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-20 no-print">
                        <div className="flex items-center gap-2 font-bold text-slate-800"><Briefcase className="text-blue-600" /><span>FinKit 財富工具箱</span></div>
                        <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="p-2 text-slate-600">{isMenuOpen ? <X /> : <Menu />}</button>
                    </div>

                    <aside className={`fixed inset-y-0 left-0 z-10 w-64 bg-white border-r border-slate-200 transform transition-transform duration-300 ease-in-out no-print md:translate-x-0 md:static md:block overflow-y-auto ${isMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-100 hidden md:flex items-center gap-2 font-bold text-xl text-slate-800 sticky top-0 bg-white z-10"><Briefcase className="text-blue-600" /><span>FinKit</span></div>
                        <nav className="p-4 space-y-6">
                            {menuCategories.map((group, idx) => (
                                <div key={idx}>
                                    <h3 className="px-4 mb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">{group.title}</h3>
                                    <div className="space-y-1">
                                        {group.items.map((tab) => {
                                            const Icon = tab.icon;
                                            const isActive = activeTab === tab.id;
                                            return (
                                                <button key={tab.id} onClick={() => { setActiveTab(tab.id); setIsMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl transition-all text-sm font-medium ${isActive ? 'bg-blue-50 text-blue-700 shadow-sm' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'}`}>
                                                    <Icon size={18} className={isActive ? 'text-blue-600' : 'text-slate-400'} />{tab.name}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </nav>
                        <div className="p-4 mt-auto">
                            <div className="bg-slate-100 border border-slate-200 border-dashed rounded-lg h-32 flex items-center justify-center text-xs text-slate-400 text-center">廣告贊助版位<br/>(AdSense / Affiliate)</div>
                        </div>
                    </aside>

                    <main className="flex-1 p-4 md:p-8 overflow-y-auto print:p-0 print:overflow-visible h-screen">
                        <div className="max-w-4xl mx-auto print:max-w-none print:w-full pb-20">
                            <div className="hidden print:block mb-8 border-b pb-4">
                                <div className="flex items-center gap-2 font-bold text-2xl text-slate-800"><Briefcase className="text-blue-600" size={32} /><span>FinKit 理財規劃報告</span></div>
                                <p className="text-slate-500 text-sm mt-1">Generated by FinKit - 讓理財規劃更有溫度</p>
                            </div>
                            <div className="w-full h-20 bg-slate-100 border border-slate-200 border-dashed rounded-xl mb-8 flex items-center justify-center text-sm text-slate-400 no-print">Google AdSense Banner (RWD)</div>
                            {renderContent()}
                            <footer className="mt-12 pt-6 border-t border-slate-200 text-center text-slate-400 text-sm print:mt-8">
                                <p>© 2025 FinKit. 用心規劃，遇見美好未來。</p>
                                <p className="mt-1 text-xs">免責聲明：本站工具僅供試算參考，不代表投資建議，實際交易結果請以銀行或券商對帳單為準。</p>
                            </footer>
                        </div>
                    </main>
                    {isMenuOpen && <div className="fixed inset-0 bg-black/20 z-0 md:hidden no-print" onClick={() => setIsMenuOpen(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinancialToolkit />);
    </script>
</body>
</html>
